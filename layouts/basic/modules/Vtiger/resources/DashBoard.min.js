jQuery.Class("Vtiger_DashBoard_Js",{gridster:!1,currentInstance:!1,addWidget:function(e,t){e=jQuery(e);var i=e.data("linkid"),a=e.data("name"),r=e.data("id");jQuery(e).parent().remove(),jQuery("ul.widgetsList li").size()<1&&jQuery("ul.widgetsList").prev("button").css("visibility","hidden");var n=jQuery('<li class="new dashboardWidget" id="'+i+"-"+r+'" data-name="'+a+'" data-mode="open"></li>');n.data("url",t);var s=e.data("width"),d=e.data("height");Vtiger_DashBoard_Js.gridster.add_widget(n,s,d),Vtiger_DashBoard_Js.currentInstance.loadWidget(n)},restrictContentDrag:function(e){e.on("mousedown.draggable",function(e){var t=jQuery(e.target),i=t.closest(".dashboardWidgetHeader").length>0?!0:!1;i||e.stopPropagation()})}},{container:!1,noCache:!1,instancesCache:{},init:function(){Vtiger_DashBoard_Js.currentInstance=this},getContainer:function(){return(1==this.noCache||0==this.container)&&(this.container=jQuery(".gridster ul")),this.container},getCurrentDashboard:function(){return $(".selectDashboard li.active").data("id")},getWidgetInstance:function(e){var t=e.attr("id");if(this.noCache||!(t in this.instancesCache)){var i=e.data("name");this.instancesCache[t]=Vtiger_Widget_Js.getInstance(e,i)}return this.instancesCache[t]},registerGridster:function(){var e=this;Vtiger_DashBoard_Js.gridster=this.getContainer().gridster({widget_margins:[7,7],widget_base_dimensions:[e.getContainer().width()/12-14,100],min_cols:6,min_rows:20,max_size_x:12,draggable:{stop:function(){e.savePositions(jQuery(".dashboardWidget"))}}}).data("gridster")},savePositions:function(e){for(var t={},i=0,a=e.length;a>i;++i){var r=jQuery(e[i]);t[r.attr("id")]=JSON.stringify({row:r.attr("data-row"),col:r.attr("data-col")})}AppConnector.request({module:"Vtiger",action:"SaveWidgetPositions",positionsmap:t}).then(function(e){})},loadWidgets:function(){var e=this,t=jQuery(".dashboardWidget");t.each(function(t,i){e.loadWidget(jQuery(i))})},loadWidget:function(e){var t=this,i=e.data("url"),a=e.data("mode");if(e.progressIndicator(),"open"==a){var r=e.data("name"),n=e.data("cache"),s=app.getMainParams("current_user_id");if(1==n){var d=app.cacheGet(r+s,!1);i=d?d:i}AppConnector.request(i).then(function(i){e.html(i),app.showSelect2ElementView(e.find(".select2")),t.getWidgetInstance(e),e.trigger(Vtiger_Widget_Js.widgetPostLoadEvent);var a=e.find(".dashboardWidgetHeader").outerHeight(),r=e.height()-a;e.find(".dashboardWidgetFooter").length&&(r-=e.find(".dashboardWidgetFooter").outerHeight());var n=e.find(".dashboardWidgetContent");n.css("max-height",r+"px"),n.css("overflow","auto"),n.perfectScrollbar()})}},gridsterStop:function(){Vtiger_DashBoard_Js.gridster},registerRefreshWidget:function(){var e=this;this.getContainer().on("click",'a[name="drefresh"]',function(t){var i=$(t.currentTarget),a=i.closest("li"),r=e.getWidgetInstance(a);r.refreshWidget()})},removeWidget:function(){this.getContainer().on("click",'li a[name="dclose"]',function(e){var t=$(e.currentTarget),i=jQuery(t).parents("li"),a=i.attr("data-sizex"),r=i.attr("data-sizey"),n=t.data("url"),s=t.closest(".dashboardWidgetHeader").parent(),d=s.data("name"),o=s.find(".dashboardTitle").attr("title"),l=app.vtranslate("JS_ARE_YOU_SURE_TO_DELETE_WIDGET")+" ["+o+"]. "+app.vtranslate("JS_ARE_YOU_SURE_TO_DELETE_WIDGET_INFO");Vtiger_Helper_Js.showConfirmationBox({message:l}).then(function(e){AppConnector.request(n).then(function(e){if(e.success){var i=[];if(s.fadeOut("slow",function(){s.remove()}),-1==jQuery.inArray(d,i)){Vtiger_DashBoard_Js.gridster.remove_widget(t.closest("li")),jQuery(".widgetsList").prev("button").css("visibility","visible");var n="<li>";e.result.deleteFromList&&(n+="<button ",n+='data-widget-id="'+e.result.id+'" ',n+='class="removeWidgetFromList btn btn-xs btn-danger pull-left" ',n+='style="width:25px;height:25px;margin:2px;" ',n+=">",n+='<span class="glyphicon glyphicon-trash"></span>',n+="</button>"),n+="<a onclick=\"Vtiger_DashBoard_Js.addWidget(this, '"+e.result.url+"')\" ",n+='href="javascript:void(0);" ',n+='class="pull-left" ',n+='data-linkid="'+e.result.linkid+'" ',n+='data-name="'+e.result.name+'" ',n+='data-width="'+a+'" ',n+='data-height="'+r+'" ',n+='style="height:30px;width:100%;margin:0;padding:5px;" ',n+=">",n+=e.result.title+"</a>",n+="</li>";var o=jQuery(".widgetsList .divider");o.length?jQuery(n).insertBefore(o):jQuery(".widgetsList").append(n)}}})},function(e,t){})})},registerSelectDashboard:function(){var e=this;$(".selectDashboard li").on("click",function(t){var i=jQuery.progressIndicator({position:"html",blockInfo:{enabled:!0}}),a=$(t.currentTarget),r=a.data("id"),n={module:app.getModuleName(),view:app.getViewName(),dashboardId:r};AppConnector.request(n).then(function(t){i.progressIndicator({mode:"hide"}),$(".dashboardViewContainer").html(t),e.noCache=!0,e.registerEvents()})})},registerDatePickerHideInitiater:function(){var e=this.getContainer();e.on("click","input.dateRange",function(e){var t=jQuery(e.currentTarget).closest(".dashboardWidget"),i=jQuery(".dashboardWidgetHeader",t),a=function(){var e=jQuery(".dateRange");e.DatePickerHide(),e.blur()};return Vtiger_Helper_Js.addClickOutSideEvent(i.find(".dateRange"),a),!1})},registerShowMailBody:function(){var e=this.getContainer();e.on("click",".showMailBody",function(e){var t=jQuery(e.currentTarget).closest(".mailRow"),i=t.find(".mailBody"),a=jQuery(e.currentTarget).find(".body-icon");"none"==i.css("display")?(i.show(),a.removeClass("glyphicon-chevron-down").addClass("glyphicon-chevron-up")):(i.hide(),a.removeClass("glyphicon-chevron-up").addClass("glyphicon-chevron-down"))})},registerChangeMailUser:function(){var e=this.getContainer();e.on("change","#mailUserList",function(e){var t=$(e.currentTarget),i=t.closest("li"),a=i.find(".dashboardWidgetContent"),r=$("option:selected",this),n=i.data("url")+"&user="+r.val(),s={};s.url=n,s.data={},a.progressIndicator({}),AppConnector.request(s).then(function(e){a.progressIndicator({mode:"hide"}),i.html(e).trigger(Vtiger_Widget_Js.widgetPostRefereshEvent)},function(){a.progressIndicator({mode:"hide"})})})},registerChartFilterWidget:function(){var e=this;$(".dashboardHeading").on("click",".addChartFilter",function(t){var i=$(t.currentTarget),a=["currency","double","percentage","integer"];app.showModalWindow(null,"index.php?module=Home&view=ChartFilter&step=step1",function(t){var r=jQuery("form",t);r.on("keypress",function(e){return 13!=e.keyCode});var n=r.find(".sectorContainer"),s=jQuery('select[name="chartType"]',t),d=jQuery('select[name="module"]',t),o=jQuery('select[name="filterid"]',t),l=jQuery('select[name="groupField"]',t);app.showSelect2ElementView(n.find(".select2"));var c=app.showSelect2ElementView(d,{placeholder:app.vtranslate("JS_SELECT_MODULE")}),h=app.showSelect2ElementView(o,{placeholder:app.vtranslate("JS_PLEASE_SELECT_ATLEAST_ONE_OPTION")}),g=app.showSelect2ElementView(l,{placeholder:app.vtranslate("JS_PLEASE_SELECT_ATLEAST_ONE_OPTION"),closeOnSelect:!0,maximumSelectionLength:6}),u=jQuery(".modal-footer",t);o.closest("tr").hide(),l.closest("tr").hide(),u.hide(),s.on("change",function(e){var t=$(e.currentTarget),i=t.val();"Barchat"==i||"Horizontal"==i?r.find(".isColorContainer").removeClass("hide"):r.find(".isColorContainer").addClass("hide")}),c.change(function(){c.val()&&(u.hide(),l.closest("tr").hide(),AppConnector.request({module:"Home",view:"ChartFilter",step:"step2",selectedModule:c.val()}).then(function(e){o.empty().html(e).trigger("change"),h.closest("tr").show()}))}),h.change(function(){h.val()&&AppConnector.request({module:"Home",view:"ChartFilter",step:"step3",selectedModule:c.val(),filterid:h.val()}).then(function(e){l.empty().html(e).trigger("change"),g.closest("tr").show(),g.data("select2").$selection.find(".select2-search__field").parent().css("width","100%")})}),g.change(function(){if(g.val()){var e=g.find(":selected").data("fieldType");"Funnel"==s.val()&&-1!=a.indexOf(e)?n.removeClass("hide"):n.addClass("hide"),u.show()}else u.hide()}),r.submit(function(t){t.preventDefault();var a=c.val(),d=c.find(":selected").text(),o=h.val(),l=h.find(":selected").text(),u=g.find(":selected").text(),p=0,v=r.find(".isColor");!v.hasClass("hide")&&v.is(":checked")&&(p=1);var f={module:a,groupField:g.val(),chartType:s.val(),color:p,sector:n.find('[name="sectorField"]').val()};e.saveChartFilterWidget(f,i,d,o,l,u,r)})})})},saveChartFilterWidget:function(e,t,i,a,r,n,s){var d=this,o={data:JSON.stringify(e),action:"addWidget",blockid:t.data("block-id"),linkid:t.data("linkid"),label:i+" - "+r+" - "+n,name:"ChartFilter",title:s.find('[name="widgetTitle"]').val(),filterid:a,isdefault:0,height:4,width:4,owners_all:["mine","all","users","groups"],default_owner:"mine",dashboardId:d.getCurrentDashboard()},l=$('[name="selectedModuleName"]').val();d.saveWidget(o,"save",l).then(function(e){var i=e.result,a={};if(e.success){app.hideModalWindow(),o.id=i.id,o.status=i.status,a.text=i.text,a.type="success";var r=t.clone();r.data("name","ChartFilter"),r.data("id",i.wid),Vtiger_DashBoard_Js.addWidget(r,"index.php?module=Home&view=ShowWidget&name=ChartFilter&linkid="+t.data("linkid")+"&widgetid="+i.wid+"&active=0"),Vtiger_Helper_Js.showMessage(a)}else{var n=e.error.message;if(513!=e.error.code)var d=s.find('[name="fieldName"]');else var d=s.find('[name="fieldLabel"]');d.validationEngine("showPrompt",n,"error","topLeft",!0)}})},registerMiniListWidget:function(){var e=this;$(".dashboardHeading").on("click",".addFilter",function(t){var i=$(t.currentTarget);app.showModalWindow(null,"index.php?module=Home&view=MiniListWizard&step=step1",function(t){var a=jQuery("form",t);a.on("keypress",function(e){return 13!=e.keyCode});var r=jQuery('select[name="module"]',t),n=jQuery('select[name="filterid"]',t),s=jQuery('select[name="fields"]',t),d=app.showSelect2ElementView(r,{placeholder:app.vtranslate("JS_SELECT_MODULE")}),o=app.showSelect2ElementView(n,{placeholder:app.vtranslate("JS_PLEASE_SELECT_ATLEAST_ONE_OPTION")}),l=app.showSelect2ElementView(s,{placeholder:app.vtranslate("JS_PLEASE_SELECT_ATLEAST_ONE_OPTION"),closeOnSelect:!0,maximumSelectionLength:6}),c=jQuery(".modal-footer",t);n.closest("tr").hide(),s.closest("tr").hide(),c.hide(),d.change(function(){d.val()&&(c.hide(),s.closest("tr").hide(),AppConnector.request({module:"Home",view:"MiniListWizard",step:"step2",selectedModule:d.val()}).then(function(e){n.empty().html(e).trigger("change"),o.closest("tr").show()}))}),o.change(function(){o.val()&&AppConnector.request({module:"Home",view:"MiniListWizard",step:"step3",selectedModule:d.val(),filterid:o.val()}).then(function(e){s.empty().html(e).trigger("change"),l.closest("tr").show(),l.data("select2").$selection.find(".select2-search__field").parent().css("width","100%")})}),l.change(function(){l.val()?c.show():c.hide()}),a.submit(function(t){t.preventDefault();var r=d.val(),n=d.find(":selected").text(),s=o.val(),c=o.find(":selected").text(),h=[];l.select2("data").map(function(e){h.push(e.id)});var g={module:r};"object"!=typeof h&&(h=[h]),g.fields=h,e.saveMiniListWidget(g,i,n,s,c,a)})})})},saveMiniListWidget:function(e,t,i,a,r,n){var s=this,d={data:JSON.stringify(e),action:"addWidget",blockid:t.data("block-id"),linkid:t.data("linkid"),label:i+" - "+r,title:n.find('[name="widgetTitle"]').val(),name:"Mini List",filterid:a,isdefault:0,height:4,width:4,owners_all:["mine","all","users","groups"],default_owner:"mine",dashboardId:s.getCurrentDashboard()},o=$('[name="selectedModuleName"]').val();s.saveWidget(d,"save",o).then(function(e){var i=e.result,a={};if(e.success){app.hideModalWindow(),d.id=i.id,d.status=i.status,a.text=i.text,a.type="success";var r=t.clone();r.data("name","MiniList"),r.data("id",i.wid),Vtiger_DashBoard_Js.addWidget(r,"index.php?module=Home&view=ShowWidget&name=MiniList&linkid="+t.data("linkid")+"&widgetid="+i.wid+"&active=0"),Vtiger_Helper_Js.showMessage(a)}else{var s=e.error.message;if(513!=e.error.code)var o=n.find('[name="fieldName"]');else var o=n.find('[name="fieldLabel"]');o.validationEngine("showPrompt",s,"error","topLeft",!0)}})},saveWidget:function(e,t,i){var a=jQuery.Deferred(),r=jQuery.progressIndicator({position:"html",blockInfo:{enabled:!0}});"undefined"==typeof i&&(i=app.getModuleName());var n={form:e,module:"WidgetsManagement",parent:"Settings",sourceModule:i,action:"SaveAjax",mode:t,addToUser:!0};return AppConnector.request(n).then(function(e){r.progressIndicator({mode:"hide"}),a.resolve(e)},function(e){r.progressIndicator({mode:"hide"}),a.reject(e)}),a.promise()},registerTabModules:function(){var e=this;$(".selectDashboradView li").on("click",function(t){var i=$(t.currentTarget);$(".selectDashboradView li").removeClass("active"),i.addClass("active");var a={module:i.data("module"),view:app.getViewName(),sourceModule:app.getModuleName(),dashboardId:e.getCurrentDashboard()};AppConnector.request(a).then(function(t){$(".dashboardViewContainer").html(t),e.noCache=!0,e.registerEvents()})})},removeWidgetFromList:function(){$(".dashboardHeading").on("click",".removeWidgetFromList",function(e){var t=$(e.currentTarget),i=t.data("widget-id"),a={module:"Vtiger",action:"RemoveWidgetFromList",id:i};AppConnector.request(a).then(function(e){var i={text:app.vtranslate("JS_WIDGET_DELETED"),type:"success",animation:"show"};Vtiger_Helper_Js.showMessage(i);var a=t.closest("li");$(a).remove()})})},registerEvents:function(){this.registerGridster(),this.loadWidgets(),this.registerRefreshWidget(),this.removeWidget(),this.registerDatePickerHideInitiater(),this.gridsterStop(),this.registerShowMailBody(),this.registerChangeMailUser(),this.registerMiniListWidget(),this.registerChartFilterWidget(),this.registerTabModules(),this.removeWidgetFromList(),this.registerSelectDashboard()}});